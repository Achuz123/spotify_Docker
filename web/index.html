<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Spotify Playlist Keyword Filter</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
    <link rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.13.5/dist/bootstrap-table.min.css">
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>
    <style type="text/css">
    @media (max-width: 991px) {
        .container {
            max-width: 98%;
        }

        h1 {
            font-size: 50px !important;
        }

        th {
            font-size: 35px !important;
        }

        td {
            font-size: 35px !important;
        }
    }

    h1,
    th {
        font-weight: 500;
    }

    h1 {
        font-size: 2rem;
        padding-left: 12px;
        line-height: 36px;
    }

    th {
        font-size: 1.5rem;
    }

    td {
        font-size: 1rem;
        font-weight: normal;
    }

    #login,
    #loggedin {
        display: none;
    }

    .text-overflow {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        width: 500px;
    }
    </style>
</head>

<body>
    <div class="container">
        <div id="login">
            <h1>Spotify Playlist Keyword Filter</h1>
            <a href="/login" class="btn btn-primary">Log in with Spotify</a>
        </div>
        <div id="loggedin" class="top jumbotron">
            <p id="info" class="text-center"></p>
            <div id="playlists">
                <h1> Pick a playlist: </h1>
                <br>
                <div>
                    <!-- <table id="playlist-list" data-toggle="table"> -->
                        <table id="playlist-list" class="table">
                        <thead>
                            <tr>
                                <!-- <th data-sortable="true">Name</th>
                                <th data-sortable="true">Track Count</th> -->
                                <th>Name</th>
                                <th>Track Count</th>
                            </tr>
                        </thead>
                        <tbody> </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <script>
    var access_token;
    var refresh_token;
    var uid;
    var logged_in = false;

    function getHashParams() {
        var hashParams = {};
        var e, r = /([^&;=]+)=?([^&;]*)/g,
            q = window.location.hash.substring(1);
        while (e = r.exec(q)) {
            hashParams[e[1]] = decodeURIComponent(e[2]);
        }

        return hashParams;
    }

    function login() {
        /**
         * Obtains parameters from the hash of the URL
         * @return Object
         */

        var params = getHashParams();
        access_token = params.access_token
        refresh_token = params.refresh_token,
            uid = params.uid,
            error = params.error;

        if (error) {
            alert("There was an error during the authentication");
        } else {
            if (access_token) {
                $.ajax({
                    url: "https://api.spotify.com/v1/me",
                    headers: {
                        "Authorization": "Bearer " + access_token
                    },
                    success: function(r) {
                        logged_in = true;
                        $("#login").hide();
                        $("#loggedin").show();

                        fetchPlaylists();
                    },
                    error: function(r) {
                        console.log("invalid access token");
                        refreshToken();
                    }
                });
            } else {
                // render initial screen
                logged_in = false;
                $("#login").show();
                $("#loggedin").hide();
            }
        }
    }

    function refreshToken() {
        $.ajax({
            url: "/refresh_token",
            data: { refresh_token: refresh_token },
            success: function(r) {
                console.log("refreshed token");
            },
            error: function(r) {
                console.log("token refresh failed");
                console.log(JSON.stringify(r));
            }
        });
    }

    function info(msg) {
        $("#info").text(msg);
    }

    function error(msg) {
        info(msg);
    }

    function fetchPlaylists(uid) {
        $("#playlist-list tbody").empty();
        info("Getting your playlists");

        var url = "https://api.spotify.com/v1/users/" + uid + "/playlists";
        var data = {
            limit: 50,
            offset: 0
        }

        getSpotify(url, data).then(r =>
            $.each(r.items, function(index, val) {
                console.log(val.name);
                $("#playlist-list").find("tbody").append("<tr><td>" + val.name + "</td><td>" + val.tracks.total + "</td></tr>");
            })
        ).catch(error => window.location("/#error=" + error));
    }

    function getSpotify(url, data) {
        return new Promise((resolve, reject) => {
            $.ajax(url, {
                dataType: "json",
                data: data,
                headers: {
                    "Authorization": "Bearer " + access_token
                },
                success: function(r) {
                    console.log(r);
                    info("");
                    resolve(r);
                },
                error: function(r) {
                    console.log("get spotify error: " + r);
                    reject("playlist_fetching");
                }
            });
        });
    }

    $(document).ready(function() {
        login();
    });
    </script>
</body>

</html>